name: Assign Reviewer based on Label

on:
  pull_request:
    types:
      - labeled

permissions:
  contents: write
  pull-requests: write

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set Reviewer
        run: |
          declare -A LABELS_TO_REVIEWERS=(
            ["feat"]="nekonado"
            ["bug"]="nekonado,nekonadocat"
          )

          label="${{ github.event.label.name }}"
          reviewers=${LABELS_TO_REVIEWERS[$label]}

          if [ -n "$reviewers" ]; then
            # レビュアーリストをJSON形式の配列に変換
            reviewers_json=$(echo $reviewers | jq -Rsc '[split(",")[] | {reviewer: .}]')

            # JSON データを生成する
            json_data=$(jq -n --argjson reviewers "$reviewers_json" '{"reviewers": $reviewers}')

            # デバッグ用に JSON データをログに出力
            echo "JSON Data: $json_data"

            # GitHub API を呼び出してレビュアーを設定
            response=$(curl -s -w "%{http_code}" -o response.txt -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers \
              -d "$json_data")

            http_code=$(tail -n1 response.txt)
            body=$(head -n-1 response.txt)

            echo "HTTP Status Code: $http_code"
            echo "Response Body: $body"
          fi
