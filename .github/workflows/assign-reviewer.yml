name: Assign Reviewer based on Label

on:
  pull_request:
    types:
      - labeled

permissions:
  contents: write
  pull-requests: write

jobs:
  assign-reviewer:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set Reviewer
        run: |
          # ラベルと対応するレビュアを定義
          declare -A LABELS_TO_REVIEWERS=(
            ["feat"]="nekonadocat"
            ["bug"]="nekonado,nekonadocat"
          )

          label="${{ github.event.label.name }}"
          reviewers=${LABELS_TO_REVIEWERS[$label]}

          if [ -n "$reviewers" ]; then
            # GitHub API を呼び出してレビュアを設定
            curl -s -w "%{http_code}" -o response.txt -X POST \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers" \
              -d "{\"reviewers\": [\"$reviewers\"]}"

            # API のレスポンスを取得
            http_code=$(tail -n1 response.txt)
            body=$(head -n-1 response.txt)

            echo "HTTP Status Code: $http_code"
            echo "Response Body: $body"
          fi
